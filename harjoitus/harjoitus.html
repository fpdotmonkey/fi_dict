<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
body {
  font-size: 30pt;
}

input[type="text"]
{
    font-size:30px;
}

input[type="submit"]
{
    font-size:30px;
}

main {
  display: flex;
  justify-content: center;
  flex-direction: column;
  align-items: left;
  max-width: 1000px;
}

legend {
  font-size: 20px;
}

#muoto-selector {
  display: flex;
  justify-content: center;
  flex-flow: column wrap;
  height: 200px;
  width: 200px;
}

.muoto {
  font-size: 20px;
}

  </style>
  <script src='node_modules/sql.js/dist/sql-wasm.js'></script>
  <script>
const config = {
  locateFile: filename => `node_modules/sql.js/dist/${filename}`
};

var db = null;

const sql_js = initSqlJs(config)
  .then(function(SQL) {
    var db_request = new XMLHttpRequest();
    db_request.responseType = "arraybuffer";
    db_request.onloadend = function() {
      db = new SQL.Database(new Uint8Array(db_request.response));
      new_prompt();
    };
    db_request.open("GET", "../verbit.sqlite", true);
    db_request.send();
  });

var muoto = "muoto-sinä";

var prompt = null;
var answer = null;
var data = null;

var correct = 0;
var wrong = 0;

function new_prompt() {
  data = db.prepare(`SELECT * FROM verbs WHERE ${column_from(muoto)} != '-' ORDER BY RANDOM() LIMIT 1`)
    .getAsObject({$start:1, $end:1});
  prompt = data["infinitive"];
  answer = data[column_from(muoto)];
  document.getElementById("prompt").textContent = prompt;
  return [prompt, answer];
}

function refresh_prompt() {
  data = db.prepare(`SELECT ${column_from(muoto)} FROM verbs WHERE infinitive = '${prompt}'`)
    .getAsObject({$start:1, $end:1});
  answer = data[column_from(muoto)];
}

function on_answer_guessed(event) {
  event.preventDefault();
  const guess = event["target"][0]["value"];
  if (guess === answer) {
    correct += 1;
    document.getElementById("feedback").textContent = "Oikea!";
    document.getElementById("answer-input").value = "";
    new_prompt();
  } else {
    wrong += 1;
    document.getElementById("feedback").textContent = "Väärin...";
  }
  document
    .getElementById("record")
    .textContent = `oikea: ${correct}, väärin: ${wrong}`;
}

function column_from(muoto) {
  switch (muoto) {
  case "muoto-minä":
    return "first_singular_present";
  case "muoto-sinä":
    return "second_singular_present";
  case "muoto-hän":
    return "third_singular_present";
  case "muoto-me":
    return "first_plural_present";
  case "muoto-te":
    return "second_plural_present";
  case "muoto-he":
    return "third_plural_present";
  }
}

function on_muoto_change(event) {
  muoto = event["target"]["value"];
  var new_answer_label = "";
  switch (muoto) {
  case "muoto-minä":
    new_answer_label = "Minä muoto";
    break;
  case "muoto-sinä":
    new_answer_label = "Sinä muoto";
    break;
  case "muoto-hän":
    new_answer_label = "Hän muoto";
    break;
  case "muoto-me":
    new_answer_label = "Me muoto";
    break;
  case "muoto-te":
    new_answer_label = "Te muoto";
    break;
  case "muoto-he":
    new_answer_label = "He muoto";
    break;
  default:
    new_answer_label = "????";
    break;
  }
  document.getElementById("answer-label").textContent = new_answer_label;
  refresh_prompt();
}

  </script>
</head>
<body>
  <main>
    <h1 id="prompt">verbi</h1>
    <form id="answer" onsubmit="on_answer_guessed(event)">
      <label id="answer-label">Sinä muoto</label>
      <input
        id="answer-input"
        type="text"
        placeholder="sanamuoto"
        spellcheck="false"
        autocorrect="off"
        autocapitalize="none">
      <input type="submit" value="Arvaa">
    </form>
    <div id="feedback">Arvaa sanamuoto</div>
    <div id="record"></div>
    <form onchange="on_muoto_change(event)">
      <fieldset id="muoto-selector">
        <legend>Valitse muoto haluat harjoitella</legend>
        <div>
          <input
            type="radio"
            name="muoto"
            value="muoto-minä"
            id="muoto-minä"  
            autocomplete="off">
          <label for="muoto-minä" class="muoto">Minä</label>
        </div>
        <div>
          <input
            type="radio"
            checked="checked"
            name="muoto"
            value="muoto-sinä"
            id="muoto-sinä"  
            autocomplete="off">
          <label for="muoto-sinä" class="muoto">Sinä</label>
        </div>
        <div>
          <input
            type="radio"
            name="muoto"
            value="muoto-hän"
            id="muoto-hän" 
            autocomplete="off">
          <label for="muoto-hän" class="muoto">Hän</label>
        </div>
        <div>
          <input
            type="radio"
            name="muoto"
            value="muoto-me"
            id="muoto-me"  
            autocomplete="off">
          <label for="muoto-me" class="muoto">Me</label>
        </div>
        <div>
          <input
            type="radio"
            name="muoto"
            value="muoto-te"
            id="muoto-te"  
            autocomplete="off">
          <label for="muoto-te" class="muoto">Te</label>
        </div>
        <div>
          <input
            type="radio"
            name="muoto"
            value="muoto-he"
            id="muoto-he"  
            autocomplete="off">
          <label for="muoto-he" class="muoto">He</label>
        </div>
      </fieldset>
    </form>
  </main>
</body>
</html>
