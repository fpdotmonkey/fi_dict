<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
body {
  font-size: 25pt;
}

input[type="submit"]
{
    font-size:25px;
}

main {
  display: flex;
  justify-content: center;
  flex-direction: column;
  align-items: left;
  max-width: 1000px;
}

legend {
  font-size: 20px;
}

.flex-row {
  display: flex;
  flex-flow: row;
}

.flex-column {
  display: flex;
  flex-flow: column;
}

.flex-align-end {
  align-items: end;
}

.flex-no-shrink {
  flex-shrink: 0;
}

.question-and-answer {
  font-size: 50px;
  font-family: serif;
  width: 100%;
}

.muoto {
  font-size: 20px;
}

  </style>
  <script src='node_modules/sql.js/dist/sql-wasm.js'></script>
  <script>
const config = {
  locateFile: filename => `node_modules/sql.js/dist/${filename}`
};

var db = null;

const sql_js = initSqlJs(config)
  .then(function(SQL) {
    var db_request = new XMLHttpRequest();
    db_request.responseType = "arraybuffer";
    db_request.onloadend = function() {
      db = new SQL.Database(new Uint8Array(db_request.response));
      new_prompt();
    };
    db_request.open("GET", "verbit.sqlite", true);
    db_request.send();
  });

var pronoun = "muoto-sinä";
var negative = false;
var tense = "tense-present";

var prompt = null;
var answer = null;
var data = null;

var correct = 0;
var wrong = 0;

function new_prompt() {
  const column = column_from(pronoun, negative, tense);
  data = db.prepare(
    `SELECT * FROM verbs WHERE ${column} != '-' ORDER BY RANDOM() LIMIT 1`
  ).getAsObject({$start:1, $end:1});
  prompt = data["infinitive"];
  answer = data[column];
  document.getElementById("prompt").textContent = prompt;
  return [prompt, answer];
}

function refresh_prompt() {
  const column = column_from(pronoun, negative, tense);
  data = db.prepare(
    `SELECT ${column} FROM verbs WHERE infinitive = '${prompt}'`
  ).getAsObject({$start:1, $end:1});
  answer = data[column];
}

function on_answer_guessed(event) {
  event.preventDefault();
  const guess = event["target"][0]["value"];
  const feedback = document.getElementById("feedback");
  if (guess.toLowerCase() === answer.toLowerCase()) {
    correct += 1;
    feedback.textContent = "Oikea!";
    feedback.setAttribute("title", "Correct!");
    document.getElementById("answer-input").value = "";
    new_prompt();
  } else {
    wrong += 1;
    feedback.textContent = "Väärin...";
    feedback.setAttribute("title", "Wrong...");
  }
  const record = document
    .getElementById("record");
  record.textContent = `oikea: ${correct}, väärin: ${wrong}`;
  record.setAttribute("title", `correct: ${correct}, wrong: ${wrong}`);
}

function column_from(pronoun, negative, tense) {
  var person = "";
  switch (pronoun) {
  case "muoto-minä":
    person = "first_singular";
    break;
  case "muoto-sinä":
    person = "second_singular";
    break;
  case "muoto-hän":
    person = "third_singular";
    break;
  case "muoto-me":
    person = "first_plural";
    break;
  case "muoto-te":
    person = "second_plural";
    break;
  case "muoto-he":
    person = "third_plural";
    break;
  default:
    person = "???"
  }
  var negativity = negative ? "_negative" : "";
  var tense_component = "";
  switch (tense) {
  case "tense-past":
    tense_component = "_past";
    break;
  case "tense-present":
    tense_component = "_present";
    break;
  default:
    tense_component = "_???"
  }

  return `${person}${negativity}${tense_component}`;
}

function on_muoto_change(event) {
  switch (event["target"]["name"]) {
  case "muoto":
    pronoun = event["target"]["value"];
    break;
  case "negative":
    negative = event["target"]["checked"];
    break;
  case "tense":
    tense = event["target"]["value"];
    break;
  default:
    console.log("unhandled muoto change");
    break;
  }

  var new_answer_label = "";
  var new_answer_label_alt = "";

  if (negative) {
    new_answer_label = "(negatiivi) ";
    new_answer_label_alt = "(negative) ";
  }

  switch (tense) {
  case "tense-past":
    new_answer_label = new_answer_label.concat("Eilen, ");
    new_answer_label_alt = new_answer_label_alt.concat("Yesterday, ");
    break;
  case "tense-present":
    break;
  default:
    console.log("unknown tense");
  }

  switch (pronoun) {
  case "muoto-minä":
    new_answer_label = new_answer_label.concat("Minä");
    new_answer_label_alt = new_answer_label_alt.concat("I");
    break;
  case "muoto-sinä":
    new_answer_label = new_answer_label.concat("Sinä");
    new_answer_label_alt = new_answer_label_alt.concat("You");
    break;
  case "muoto-hän":
    new_answer_label = new_answer_label.concat("Hän");
    new_answer_label_alt = new_answer_label_alt.concat("He/She/It");
    break;
  case "muoto-me":
    new_answer_label = new_answer_label.concat("Me");
    new_answer_label_alt = new_answer_label_alt.concat("We");
    break;
  case "muoto-te":
    new_answer_label = new_answer_label.concat("Te");
    new_answer_label_alt = new_answer_label_alt.concat("Y'all");
    break;
  case "muoto-he":
    new_answer_label = new_answer_label.concat("He");
    new_answer_label_alt = new_answer_label_alt.concat("They");
    break;
  default:
    console.log("unknown pronoun");
    new_answer_label = new_answer_label.concat("????");
    new_answer_label_alt = new_answer_label_alt.concat("????");
    break;
  }

  const answer_label = document.getElementById("answer-label");
  answer_label.textContent = new_answer_label;
  answer_label.setAttribute("title", new_answer_label_alt);
  refresh_prompt();
}

  </script>
</head>
<body>
  <main>
    <form id="answer" onsubmit="on_answer_guessed(event)">
      <div class="flex-row flex-align-end">
        <label
          id="answer-label"
          class="flex-no-shrink"
          for="prompt"
          title="You"
          >Sinä</label>
        <div style="width: 0.5em"></div>
        <div class="flex-column">
          <div id="prompt" class="question-and-answer">verbi</div>
          <div class="flex-row">
            <input
              id="answer-input"
              class="question-and-answer"
              type="text"
              placeholder="sanamuoto"
              spellcheck="false"
              autocorrect="off"
              autocapitalize="none">
            <input type="submit" value="Arvaa" title="Guess">
          </div>
        </div>
      </div>
    </form>
    <div>
      <span id="feedback" title="Guess the word form">Arvaa sanamuoto</span>
    </div>
    <div><span id="record"></span></div>
    <div style="height: 1em"></div>
    <form onchange="on_muoto_change(event)">
      <fieldset style="width: 200px">
        <legend>Valitse muoto jota haluat harjoitella</legend>
        <div>
          <input
            type="checkbox" id="negative" name="negative" autocomplete="off">
          <label for="negative" class="muoto">Negatiivi</label>
        </div>
        <label>Pronomini</label>
        <div class="flex-row">
          <div class="flex-column">
            <div>
              <input
                type="radio"
                name="muoto"
                value="muoto-minä"
                id="muoto-minä"
                autocomplete="off">
              <label for="muoto-minä" class="muoto">Minä</label>
            </div>
            <div>
              <input
                type="radio"
                checked="checked"
                name="muoto"
                value="muoto-sinä"
                id="muoto-sinä"
                autocomplete="off">
              <label for="muoto-sinä" class="muoto">Sinä</label>
            </div>
            <div>
              <input
                type="radio"
                name="muoto"
                value="muoto-hän"
                id="muoto-hän"
                autocomplete="off">
              <label for="muoto-hän" class="muoto">Hän</label>
            </div>
          </div>
          <div class="flex-column">
            <div>
              <input
                type="radio"
                name="muoto"
                value="muoto-me"
                id="muoto-me"
                autocomplete="off">
              <label for="muoto-me" class="muoto">Me</label>
            </div>
            <div>
              <input
                type="radio"
                name="muoto"
                value="muoto-te"
                id="muoto-te"
                autocomplete="off">
              <label for="muoto-te" class="muoto">Te</label>
            </div>
            <div>
              <input
                type="radio"
                name="muoto"
                value="muoto-he"
                id="muoto-he"
                autocomplete="off">
              <label for="muoto-he" class="muoto">He</label>
            </div>
          </div>
        </div>
        <label>Aikamuoto</label>
        <div>
          <div>
            <input
                type="radio"
                checked="checked"
                name="tense"
                value="tense-present"
                id="tense-present"
                autocomplete="off">
            <label for="tense-present" class="muoto">Preesens</label>
          </div>
          <div>
            <input
                type="radio"
                name="tense"
                value="tense-past"
                id="tense-past"
                autocomplete="off">
            <label for="tense-past" class="muoto">Mennyt</label>
          </div>
        </div>
      </fieldset>
    </form>
  </main>
</body>
</html>
